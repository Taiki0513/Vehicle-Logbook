<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Vehicle Logbook</title>
    <link rel="icon" type="images/jpg" href="images/icon.jpg">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://unpkg.com/microcms-js-sdk@latest/dist/umd/microcms-js-sdk.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.0/dist/browser-image-compression.js"></script>
</head>

<body>
    <div id="app">
        <div id="app">
                <div :class="{ hidden: !isLoading }" id="loader">
                    <p>Loading...</p>
                </div>
          </div>
        <!---------------------------------------------- Home ---------------------------------------------->
        <div id="home" v-if="appStatus === HOME" class="contents">
            <div class="header">
                <p>Home</p>
            </div>
            <div id="home-image-container">
                <img v-bind:src="vehicle.imageBase64" v-if="vehicle.imageBase64">
                <div v-if="!vehicle.imageBase64" id="image-not-selected">
                    <p>画像が選択されていません</p>
                </div>
            </div>
            <div id="home-info-container">
                <dl>
                    <dt>メーカー</dt>
                    <dd>{{ vehicle.brand }}</dd>
                    <dt>車名</dt>
                    <dd>{{ vehicle.name }}</dd>
                    <dt>形式</dt>
                    <dd>{{ vehicle.modelCode }}</dd>
                    <dt>購入日</dt>
                    <dd>{{ vehicle.purchaseDate }}</dd>
                </dl>
            </div>
        </div>
        <!-------------------------------------------------------------------------------------------------->

        <!------------------------------------------- Maintenance ------------------------------------------>
        <div id="maintenance" v-if="appStatus === MAINTENANCE" class="contents">
            <div class="header">
                <p>Maintenance</p>
            </div>
            <div class="condition-container">
                <select id="maintenance-condition" v-model="selectedOption">
                    <option v-for="(option, index) in selectOptions" :key="option.id" :value="option.name">{{ option.name }}</option>
                </select>
                <button class="passed-days-button" v-on:click="showModal(PASSEDDAYS_MODE)">経過日数表示</button>
                <button v-on:click="showModal(ADD_MODE)">追加</button>
            </div>
            <div class="table-container">
                <table>
                    <template v-for="(log, index) in filteredMaintenanceLogs" :key="log.id">
                        <log-row :log="log" 
                                 :format-price="formatPrice" 
                                 :show-modal="showModal" 
                                 :edit-mode="EDIT_MODE" 
                                 :delete-mode="DELETE_MODE"
                                 :app-status="appStatus"
                                 :maintenance="MAINTENANCE"
                                 :custom="CUSTOM"/>
                    </template>
                </table>
            </div>
        </div>
        <!-------------------------------------------------------------------------------------------------->

        <!---------------------------------------------- Custom -------------------------------------------->
        <div id="maintenance" v-if="appStatus === CUSTOM" class="contents">
            <div class="header">
                <p>Custom</p>
            </div>
            <div class="condition-container">
                <select class="custom-sort" v-model="customOrderCnd"  v-on:change="setCustomOrderToLocalStorage">
                    <option :value=1>追加順</option>
                    <option :value=2>価格順</option>
                    <option :value=3>日付順</option>
                </select>
                <select class="custom-sort" v-model="customOrderDir"  v-on:change="setCustomOrderToLocalStorage">
                    <option :value=1>降順</option>
                    <option :value=2>昇順</option>
                </select>
                <div id="total-container">
                    <p>{{ formatPrice(totalPriceOfCustom) }}</p>
                </div>
                <button v-on:click="showModal(ADD_MODE)">追加</button>
            </div>
            <div class="table-container">
                <table >
                    <template v-for="(log, index) in orderedCustomLogs" :key="log.id">
                        <log-row :log="log" 
                                 :format-price="formatPrice" 
                                 :show-modal="showModal" 
                                 :edit-mode="EDIT_MODE" 
                                 :delete-mode="DELETE_MODE"
                                 :app-status="appStatus"
                                 :maintenance="MAINTENANCE"
                                 :custom="CUSTOM"/>
                    </template>
                </table>
            </div>
        </div>
        <!-------------------------------------------------------------------------------------------------->

        <!------------------------- モーダル表示 Maintenance & Custom & Settings 共通 ------------------------>
        <div id="cover-display" v-if="isModalVisible"></div>

        <div class="modal" v-if="isModalVisible">
            <!-- タイトル -->
            <div class="modal-title">
                {{ modalTitle }}
            </div>
            <hr>
            <!-- コンテンツ -->
            <!-- 修正・追加 -->
            <div v-if="modalStatus === ADD_MODE || modalStatus === EDIT_MODE">
                    項目: <select v-model="inputName" v-if="appStatus === MAINTENANCE">
                            <option v-for="(item,index) in maintenanceItems" :key="item.id">{{ item.name }}</option>
                        </select>
                    <input type="text" class="input-mid" ref="itemInput" v-model="inputName" v-else="appStatus === CUSTOM" placeholder="必須入力">
                    <span class="alert" v-if="isAlertVisible && appStatus !== MAINTENANCE">&nbsp;※</span><br>
                <template v-if="appStatus === SETTINGS">
                    経過後警告表示日数: <input type="number" class="input-narrow" v-model="inputThreshold">
                    <span class="note">&nbsp;※0は設定なし</span>
                </template>
                <template v-if="appStatus === CUSTOM">
                    ﾒｰｶｰ: <input type="text" class="input-mid" v-model="inputBrand"><br> 
                    機種: <input type="text" class="input-mid" v-model="inputItemCode"><br> 
                </template>
                <template v-if="appStatus !== SETTINGS">
                    金額: <input type="number" class="input-mid" v-model="inputPrice"><br>
                    備考: <input type="text" class="input-wide" v-model="inputNote"><br>
                    日付: <input type="date" v-model="inputDate">
                </template>
                <div class="modal-btns">
                    <button v-on:click="initInput()">キャンセル</button>
                    <button v-on:click="checkRequiredVal()" v-if="modalStatus === ADD_MODE">追加</button>
                    <button v-on:click="setEditedVarToTable()" v-else="modalStatus === EDIT_MODE">決定</button>
                </div>
            </div>
            <!-- 削除 -->
            <div v-else-if="modalStatus === DELETE_MODE">
                <p>{{ appStatus !== SETTINGS ? `${targetDate}の"${targetItem}"のデータを削除します。` : `"${targetItem}"のデータを削除します。`}}</p>
                <p>よろしいですか？
                <div class="modal-btns">
                    <button v-on:click="() => { isModalVisible = false }">キャンセル</button>
                    <button v-on:click="deleteRecFromLogs()">OK</button>
                </div>
            </div>
            <!-- 経過日数表示 -->
            <div v-else-if="modalStatus === PASSEDDAYS_MODE">
                <div id="passed-days-container">
                    <table>
                        <tr hidden>
                            <th>項目名</th>
                            <th>経過日数</th>
                        </tr>
                        <tr v-for="item in itemsWithPassedDays" v-bind:style="{ color: item.hasAlertDaysPassed ? 'red' : '' }">
                            <td>{{ item.name }}</td>
                            <td>{{ item.date }}</td>
                        </tr>
                    </table>
                </div>
                <div class="modal-btns">
                    <button v-on:click="() => { isModalVisible = false }">閉じる</button>
                </div>
            </div>
            <!-- 車両情報修正 -->
            <div v-else-if="modalStatus === VEHICLE_MODE">
                ﾒｰｶｰ: <input type="text" class="input-mid" ref="itemInput" v-model="inputVBrand" v-if="appStatus === SETTINGS" placeholder="必須入力"> 
                    <span class="alert" v-if="isAlertVisible === true">&nbsp;※</span>
                <br>
                車名: <input type="text" class="input-mid" v-model="inputVName"><br> 
                形式: <input type="text" class="input-mid" v-model="inputVModelCode"><br>                 
                金額: <input type="number" class="input-mid" v-model="inputVPrice"><br>
                購入: <input type="date" v-model="inputVDate"><br>
                備考: <input type="text" class="input-mid" v-model="inputVNote"><br>
                画像: <button v-on:click="openFileInput">{{ tmpImageBase64 ? "選択済" : "画像を選択する"}}</button>
                    <!--発火するのはこっち↓-->
                    　<input type="file" v-on:change="handleFileUpload" ref="fileInput" hidden>

                <div class="modal-btns">
                    <button v-on:click="()=>{isModalVisible = false}">キャンセル</button>
                    <button v-on:click="setEditedVarToTable()">決定</button>
                </div>
            </div>
            <!-- お知らせ -->
            <div v-else-if="modalStatus === NOTIFICATION_MODE">
                <p  id="notification">{{ notification }}</p>
                <div class="modal-btns">
                    <button v-on:click="()=>{isModalVisible = false}">OK</button>
                </div>
            </div>
        </div>
        <!-------------------------------------------------------------------------------------------------->

        <!--------------------------------------------- Settings ------------------------------------------->
        <div id="Settings" v-if="appStatus === SETTINGS" class="contents">
            <div class="header">
                <p>Settings</p>
            </div>
            <div id="settings-main">
                <div class="dummy"></div>
                <button v-on:click="()=>isMainteItemTableVisible = true" >メンテナンス項目保守</button>
                <button v-on:click="showModal(VEHICLE_MODE)">車両情報修正</button>
                <button v-on:click="toggleColorMode()">{{ colorMode === DARK_MODE ? "ライトモード" : "ダークモード" }}</button>
                <button v-on:click="generateAndDownloadFile">csvデータ出力</button>
                <div class="dummy"></div>
            </div>
            
            <div id="master-area"  v-if="isMainteItemTableVisible">
                <div id="master-table-container">
                    <table>
                        <tr>
                            <th>メンテナンス項目名</th>
                            <th>経過後警告表示日数</th>
                            <th></th>
                        </tr>        
                        <tr v-for="item in maintenanceItems" v-if="isMainteItemTableVisible">
                            <td class="name-td">{{ item.name }}</td>
                            <td class="name-td" :class="{ 'alert-threshold-days': item.thresholdDays > 0 }">{{ item.thresholdDays !== 0 ? item.thresholdDays : "設定なし" }}</td>
                            <td>
                                <div class="button-area">
                                    <button v-on:click="showModal(EDIT_MODE,item.id)">修正</button>
                                    <button v-on:click="showModal(DELETE_MODE,item.id)">削除</button>
                                </div>
                            </td>
                        </tr>        
                        
                    </table>
                </div>
                <div id="button-area-master">
                    <button v-on:click="showModal(ADD_MODE)">追加</button>
                    <button v-on:click="()=>isMainteItemTableVisible = false">キャンセル</button>
                </div>
            </div>

        </div>

        <!-------------------------------------------------------------------------------------------------->
        <div id="footer-menu">
            <div>
                <button v-on:click="()=>{ appStatus = HOME }" v-bind:style="{ backgroundColor: appStatus === HOME ? PRIMARY_COLOR: SECONDARY_COLOR }">Home</button>
            </div>
            <div>
                <button v-on:click="()=>{ appStatus = MAINTENANCE }" v-bind:style="{ backgroundColor: appStatus === MAINTENANCE ? PRIMARY_COLOR : SECONDARY_COLOR }" v-bind:disabled="!this.maintenanceItems[0]">Mainte</button>
            </div>
            <div>
                <button v-on:click="()=>{ appStatus = CUSTOM }" v-bind:style="{ backgroundColor: appStatus === CUSTOM ? PRIMARY_COLOR : SECONDARY_COLOR }">Custom</button>
            </div>
            <div>
                <button v-on:click="()=>{ appStatus = SETTINGS }" v-bind:style="{ backgroundColor: appStatus === SETTINGS ? PRIMARY_COLOR : SECONDARY_COLOR }">Settings</button>
            </div>
        </div>
    </div>
    <script>
        const appdata = {
            data(){
                return{
                    // 状態定数(疑似) /////////////////////
                    //appStatusと対応
                    HOME:"home",
                    MAINTENANCE:"maintenance",
                    CUSTOM:"custom",
                    SETTINGS:"settings",
                    //modalStatusと対応
                    EDIT_MODE:"edit",
                    ADD_MODE:"add",
                    DELETE_MODE:"delete",
                    PASSEDDAYS_MODE:"passedDays",
                    VEHICLE_MODE:"vehicle",
                    NOTIFICATION_MODE:"notification",
                    ///////////////////////////////////////
                    login:false,
                    isLoading:true,
                    modalTitle:"",
                    modalStatus:"",
                    appStatus:"",
                    notification:"",
                    selectedOption:"全件表示",
                    isModalVisible:false,
                    isAlertVisible:false,
                    isMainteItemTableVisible:false,
                    isVehicleEditVisible:false,
                    // 入力変数 ////////////////////////////
                    inputPassword:"",
                    inputUserName:"",
                    ///////////////////////////////////////
                    //車両
                    vehicles:[{}],//全車両
                    vehicle:"",
                    // apiデータ格納変数・定数 //////////////
                    SERVICE_DOMAIN:"taiki6134",
                    API_KEY:"pXftWgjkaejG6wGDAtuzXxY9vqQtZPEK3Rgq",
                    userId:1,//レガシー
                    user:[],
                    users:[],
                    nextMaintenanceItemsId:0,
                    maintenanceItems:[],//カスタマイズに関しては項目が雑多なのと、繰り返し行うことがないので自由入力とする。            
                    nextLogsId:0,
                    maintenanceLogs:[], //メンテナンス履歴(category_flg:1)
                    customLogs:[],      //カスタマイズ履歴(category_flg:2)　                    
                    ///////////////////////////////////////
                    // 設定変数 ////////////////////////////
                    // 設定初期値
                    PRIMARY_COLOR:"#1c1c1c",
                    SECONDARY_COLOR:"#000000",
                    //colorModeと対応
                    DARK_MODE:"dark",
                    LIGHT_MODE:"light",
                    // 設定格納変数
                    tmpImageBase64:"",
                    headerColor:"",
                    headerFontColor:"",
                    colorMode:"",
                    customOrderCnd:0,//1追加順 2価格順 3日付順
                    customOrderDir:0,//1降順 2昇順
                    ///////////////////////////////////////
                }
            },
            components:{
                "log-row": {
                    template: `
                        <tr>
                            <td class="item-td">{{ log.item }}</td>
                            <td rowspan="2" class="date-td">{{ log.date }}</td>
                            <td rowspan="2" class="price-td" v-if="log.price > 0"><p>{{ formatPrice(log.price) }}</p></td>
                            <td rowspan="2" class="price-td" v-else><p>0</p></td>
                            <td rowspan="2" class="button-td">
                                <div class="button-area">
                                    <button v-on:click="showModal(editMode,log.id)">修正</button>
                                    <button v-on:click="showModal(deleteMode,log.id)">削除</button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td v-if="appStatus === maintenance" class="note-td">{{ log.note }}</td>
                            <template v-else-if="appStatus === custom">
                                <td class="note-td" v-if="log.brand !== null && log.item_code !== null">{{ log.brand + " : " + log.item_code }}</td>
                                <td class="note-td" v-else-if="log.brand !== null  && log.item_code === null">{{ log.brand }}</td>
                                <td class="note-td" v-else-if="log.brand === null  && log.item_code !== null">{{ log.item_code }}</td>
                                <td class="note-td" v-else>{{ log.item_code }}</td>
                            </template>
                        </tr>
                    `,
                    props: ["log", "formatPrice", "showModal","editMode","deleteMode","appStatus","maintenance","custom"]
                }
            },
            computed:{
                ordererdMaintenanceLogs(){
                    return this.maintenanceLogs.toSorted((a,b)=>{
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        return dateB - dateA;
                    })
                },
                filteredMaintenanceLogs(){
                    let i = 0
                    return this.ordererdMaintenanceLogs.filter(log => {
                            if(this.selectedOption === "全件表示"){
                                return log;
                            }else{
                                return log.item === this.selectedOption;
                            }
                        });
                },
                orderedCustomLogs(){
                    //customOrderCnd 1追加 2値段 3日付
                    //customOrderDir 1降順 2昇順
                    return this.customLogs.sort((a,b) => {
                        if(this.customOrderCnd === 1){
                            if(this.customOrderDir === 1){
                                return b.id - a.id;
                            }else{
                                return a.id - b.id;
                            }
                        }else if(this.customOrderCnd === 2){
                            if(this.customOrderDir === 1){
                                return b.price - a.price;
                            }else{
                                return a.price - b.price;
                            } 
                        }else if(this.customOrderCnd === 3){
                            const dateA = new Date(a.date);
                            const dateB = new Date(b.date);
                            if (this.customOrderDir === 1) {
                                return dateB - dateA;
                            } else {
                                return dateA - dateB;
                            }
                        };
                    });
                },
                selectOptions(){
                    let i = 1;
                    //経過日数確認で再利用したいのでdateも入れる
                    let options = [{id: 1,name: "全件表示",date:""}];

                    this.maintenanceLogs.forEach((log) => {
                        //重複を除いてoption要素にする
                        let hasName = false;
                        options.forEach(option=>{
                            if(option.name === log.item){
                                hasName = true;
                            }else{
                                i++;
                            }
                        });

                        if(!hasName) options.push({ id: i,name: log.item, date:log.date });
                        hasName = false;
                    });
                    return options;
                },
                totalPriceOfCustom(){
                    let totalPrice = 0;
                    this.customLogs.forEach((log)=>{
                        totalPrice += log.price;
                    });
                    return totalPrice;
                },
                itemsWithPassedDays() {
                    return this.selectOptions.slice(1).map(option => {
                        const elapsedDaysInfo = this.calculateElapsedDays(option.date, option.name);
                        return {
                            name: option.name,
                            date: `${elapsedDaysInfo.elapsedDays}日`,
                            hasAlertDaysPassed: elapsedDaysInfo.hasAlertDaysPassed
                        };
                    });
                }
            },
            watch: {
                appStatus: {
                    handler(newValue) {
                    this.setModalTitle();
                    },
                    immediate: true
                },
                modalStatus: {
                    handler(newValue) {
                    this.setModalTitle();
                    },
                    immediate: true
                }
            },
            methods: {
                calculateElapsedDays(startDate, name) {
                    const INCLUDE_START_DATE = false;

                    let from = new Date(startDate);
                    let to = new Date();

                    if (INCLUDE_START_DATE) {
                        // 初日を含める場合、開始日を前日に設定(from:2024/4/2 to:2024/04/02 → 1日経過)
                        from.setDate(from.getDate() - 1);
                    }

                    let milliSec = to.getTime() - from.getTime();
                    let elapsedDays = Math.floor(milliSec / (1000 * 60 * 60 * 24));

                    // 警告表示日数を経過しているかチェック
                    let hasAlertDaysPassed = false;
                    this.maintenanceItems.forEach(item => {
                        if (item.name === name) {
                            if (item.thresholdDays !== 0 && item.thresholdDays < elapsedDays) {
                                hasAlertDaysPassed = true;
                            }
                        }
                    });

                    return { elapsedDays, hasAlertDaysPassed };
                },
                showAlertIfPassed() {
                    let hasAlertDaysPassed = false;

                    this.selectOptions.forEach(option => {
                        const elapsedDaysInfo = this.calculateElapsedDays(option.date, option.name);
                        if (elapsedDaysInfo.hasAlertDaysPassed) {
                            hasAlertDaysPassed = true;
                        }
                    });

                    if (hasAlertDaysPassed) {
                        this.notification = "警告日数超過項目があります。";
                        this.showModal(this.NOTIFICATION_MODE);
                    }
                },
                formatPrice(price){ return price.toLocaleString(); },
                //モーダル表示処理///////////////////////////////////////////////////////////
                showModal(mode,id){
                    this.modalStatus = mode;
                    switch(mode){
                        case this.ADD_MODE:
                            this.initInput();
                            this.isModalVisible = true;
                            if(this.appStatus === this.CUSTOM || this.appStatus === this.SETTINGS){
                                //v-ifによりDOMがレンダリングされるより前に発火するとエラーになるので対応
                                setTimeout(() => { this.$refs.itemInput.focus(); }, 1000/5)
                                if(this.appStatus === this.SETTINGS) this.inputThreshold = 0;//初期値(設定なし)
                            }
                            break;
                        case this.EDIT_MODE:
                            this.getTargetData(id);
                            this.inputName = this.targetItem;
                            if(this.appStatus !== this.SETTINGS){
                                this.inputBrand = this.targetBrand;
                                this.inputItemCode = this.targetItemCode;
                                this.inputNote = this.targetNote;
                                this.targetDate = this.targetDate.replaceAll("/","-");
                                this.inputDate = this.targetDate;
                                this.inputPrice = this.targetPrice;
                            }else{
                                this.inputThreshold = this.targetThreshold;
                            }
                            this.isModalVisible = true;
                            console.log(this.modalStatus,this.isModalVisible)
                            break;
                        case this.DELETE_MODE:
                            this.getTargetData(id);
                            this.isModalVisible = true;
                            break;
                        case this.PASSEDDAYS_MODE:
                            this.isModalVisible = true;
                            console.log(this.modalStatus,this.isModalVisible)
                            break;
                        case this.VEHICLE_MODE:
                            this.inputVName = this.vehicle.name;
                            this.inputVBrand = this.vehicle.brand;
                            this.inputVModelCode = this.vehicle.modelCode;
                            this.inputVPrice = this.vehicle.price;
                            this.inputVDate = this.vehicle.purchaseDate.replaceAll("/","-");
                            this.inputVNote = this.vehicle.note; 
                            this.isModalVisible = true;
                            break;
                        case this.NOTIFICATION_MODE:
                            this.isModalVisible = true;
                            break;
                    }
                },
                setModalTitle(){
                    if(this.appStatus !== this.SETTINGS ){
                        if(this.modalStatus === this.ADD_MODE){
                            this.modalTitle = "記録追加"
                        }else if(this.modalStatus === this.EDIT_MODE){
                            this.modalTitle = "記録修正"
                        }
                    }else{
                        if(this.modalStatus === this.VEHICLE_MODE){
                            this.modalTitle = "車両情報修正"
                        }else{
                            if(this.modalStatus === this.ADD_MODE){
                                this.modalTitle = "項目追加"
                            }else if(this.modalStatus === this.EDIT_MODE){
                                this.modalTitle = "項目修正"
                            }
                        }
                    }
                    if(this.modalStatus === this.DELETE_MODE){
                        this.modalTitle = "削除確認"
                    }else if(this.modalStatus === this.PASSEDDAYS_MODE){
                        this.modalTitle = "経過日数一覧"
                    }else if(this.modalStatus === this.NOTIFICATION_MODE){
                        this.modalTitle = "お知らせ"
                    }
                    
                },
                ///////////////////////////////////////////////////////////////////////////
                checkRequiredVal(){
                    if(this.inputName === ""){
                        this.isAlertVisible=true;
                        this.$refs.itemInput.focus();
                    }else{
                        this.insertNewRecToLogs();
                    }
                },
                getTargetData(id){          
                        switch(this.appStatus){
                            //共通 idからindexを取得 ⇒ indexから各種項目を取得
                            case this.MAINTENANCE:
                                this.targetIndex = this.maintenanceLogs.findIndex(log => log.id === id);
                                this.targetId = this.maintenanceLogs[this.targetIndex].id;
                                this.targetItem = this.maintenanceLogs[this.targetIndex].item;
                                this.targetNote = this.maintenanceLogs[this.targetIndex].note;
                                this.targetPrice = this.maintenanceLogs[this.targetIndex].price;
                                this.targetDate = this.maintenanceLogs[this.targetIndex].date;
                                break;
                            case this.CUSTOM:   
                                this.targetIndex = this.customLogs.findIndex(log => log.id === id);
                                this.targetId = this.customLogs[this.targetIndex].id;
                                this.targetItem = this.customLogs[this.targetIndex].item;
                                this.targetBrand = this.customLogs[this.targetIndex].brand;
                                this.targetItemCode = this.customLogs[this.targetIndex].item_code;
                                this.targetNote = this.customLogs[this.targetIndex].note;
                                this.targetPrice = this.customLogs[this.targetIndex].price;
                                this.targetDate = this.customLogs[this.targetIndex].date;
                                break;
                            case this.SETTINGS:
                                this.targetIndex = this.maintenanceItems.findIndex(item => item.id === id);
                                this.targetId = this.maintenanceItems[this.targetIndex].id;
                                this.targetItem = this.maintenanceItems[this.targetIndex].name;
                                this.targetThreshold = this.maintenanceItems[this.targetIndex].thresholdDays;
                                break;
                        }
                },
                setDateStr(inDate){
                    // "yyyy/mm/dd"の文字型で保存 
                        let dateTime = 0;
                        let year = 0;
                        let month = 0;
                        let date = 0;

                        dateTime = new Date(inDate);
                        year = dateTime.getFullYear();
                        month = dateTime.getMonth()+1;
                        date = dateTime.getDate();
                        dateStr = `${year}/${month < 10 ? "0" + month : month }/${ date < 10 ? "0" + date : date}`;
                        return dateStr;
                },
                initInput(){
                        // 入力モーダル初期値
                        switch(this.appStatus){
                            case this.MAINTENANCE: 
                                this.inputName = this.maintenanceItems.slice(-1)[0].name;
                                break;
                            case this.CUSTOM: 
                                this.inputName = "";
                                this.inputBrand = "";
                                this.inputItemCode = "";
                                break;
                            case this.SETTINGS:
                                this.inputName = "";
                        }
                        if(this.appStatus !== this.SETTINGS){
                            const today = new Date();
                            let year = today.getFullYear();
                            let month = today.getMonth()+1;
                            let date = today.getDate();
                            this.inputDate = `${year}-${month < 10 ? "0"+month : month}-${date < 10 ? "0" + date : date}`;
                            this.inputNote = "";
                            this.inputPrice = "";
                        }
                        this.isModalVisible = false;
                        this.isAlertVisible = false;
                        this.confirmationVisible = false;
                },
                openFileInput() {
                    this.$refs.fileInput.click();
                },
                handleFileUpload(event) {
                    const file = event.target.files[0];
                    const options = { maxSizeMB: 0.2, maxWidthOrHeight: 1300}
                    imageCompression(file, options).then((compressedFile)=> { //Browser Image Compressionで圧縮
                        if (compressedFile) {
                            const reader = new FileReader();
                            reader.readAsDataURL(compressedFile); //Base64形式に変換、reader.onloadが発火
                            reader.onload = () => { this.tmpImageBase64 = reader.result; };
                        }
                    })
                },
                generateAndDownloadFile() {

                    let textData = "～メンテナンス保守履歴～";
                    textData += '\n';
                    let headerRow = Object.keys(this.maintenanceLogs[0]).join(', ');
                    textData += headerRow + '\n';
                    
                    this.maintenanceLogs.forEach(log => {
                        textData += (log.category_flg || '') + ",";
                        textData += (log.id || '') + ",";
                        textData += (log.item || '') + ",";
                        textData += (log.brand || '') + ",";
                        textData += (log.item_code || '') + ",";
                        textData += (log.price || '') + ",";
                        textData += (log.note || '') + ",";
                        textData += (log.date || '');
                        textData += '\n';
                    });

                    textData += '\n';
                    textData += "～カスタマイズ保守履歴～";
                    textData += '\n';
                    textData += headerRow + '\n';
                    
                    this.customLogs.forEach(log => {
                        textData += (log.category_flg || '') + ",";
                        textData += (log.id || '') + ",";
                        textData += (log.item || '') + ",";
                        textData += (log.brand || '') + ",";
                        textData += (log.item_code || '') + ",";
                        textData += (log.price || '') + ",";
                        textData += (log.note || '') + ",";
                        textData += (log.date || '');
                        textData += '\n';
                    });

                    textData += '\n';
                    textData += "～メンテナンス項目マスタ～";
                    textData += '\n';
                    headerRow = Object.keys(this.maintenanceItems[0]).join(', ');
                    textData += headerRow + '\n';
                    
                    this.maintenanceItems.forEach(item => {
                        textData += (item.id || '') + ",";
                        textData += (item.name || '') + ",";
                        textData += (item.thresholdDays || '') + ",";
                        textData += '\n';
                    });

                    const blob = new Blob([textData], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = "Motorcycle Logbook Data.txt";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // BlobオブジェクトのURLを解放
                    window.URL.revokeObjectURL(url);
                },
                ///////////////////////////////////////////////////////////////////////////////////////////////
                //localStorage操作関数/////////////////////////////////////////////////////////////////////////
                ///////////////////////////////////////////////////////////////////////////////////////////////
                setCustomOrderToLocalStorage(){
                    localStorage.setItem("customOrderDir",this.customOrderDir);
                    localStorage.setItem("customOrderCnd",this.customOrderCnd);
                },
                toggleColorMode(){
                    document.body.classList.toggle('light-mode');
                    if(this.colorMode === this.DARK_MODE){
                        localStorage.setItem("colorMode",this.LIGHT_MODE);
                        this.colorMode = this.LIGHT_MODE;
                        this.PRIMARY_COLOR = "#f4f5f7";
                        this.SECONDARY_COLOR = "#ebebeb";
                    }else{
                        localStorage.setItem("colorMode",this.DARK_MODE)
                        this.colorMode = this.DARK_MODE;
                        this.PRIMARY_COLOR = "#1c1c1c";
                        this.SECONDARY_COLOR = "#000000";
                    }
                },
                setLocalStorageToVar(){
                    //カラーモード設定セット
                    this.colorMode = localStorage.getItem("colorMode");
                    if(!this.colorMode){
                        this.colorMode = this.DARK_MODE;//デフォルト
                        localStorage.setItem("colorMode",this.colorMode);
                    }                    
                    //色セット
                    if(this.colorMode === this.DARK_MODE){
                        this.PRIMARY_COLOR = "#1c1c1c";
                        this.SECONDARY_COLOR = "#000000";
                    }else{
                        this.PRIMARY_COLOR = "#f4f5f7";
                        this.SECONDARY_COLOR = "#ebebeb";
                        document.body.classList.add('light-mode');
                    }                    
                    //カスタムソート条件セット
                    this.customOrderCnd = parseFloat(localStorage.getItem("customOrderCnd"));
                    this.customOrderDir = parseFloat(localStorage.getItem("customOrderDir"));
                    if(!this.customOrderCnd) this.customOrderCnd = 1;
                    if(!this.customOrderDir) this.customOrderDir = 1;
                },
                ///////////////////////////////////////////////////////////////////////////////////////////////
                //microCMSでのデータ操作関数/////////////////////////////////////////////////////////////////////
                ///////////////////////////////////////////////////////////////////////////////////////////////
                setVehiclesToVar() {
                    const { createClient } = microcms;
                    const client = createClient({
                        serviceDomain: this.SERVICE_DOMAIN,
                        apiKey: this.API_KEY,
                    });
                    return client.getAllContents({
                        endpoint: 'vehicles',
                    }).then((res) => {
                        let contents = res;
                        contents.forEach((content) => {
                            this.vehicles.push({
                                id: parseFloat(content.id),
                                brand: content.brand,
                                name: content.name,
                                modelCode: content.model_code,
                                purchaseDate: this.setDateStr(content.purchase_date),
                                price: content.price,
                                note: content.note,
                                imageBase64: content.image_base64
                            });
                        });
                        this.vehicle = this.vehicles[2]//一旦車両切替機能は無し
                    });
                },
                setLogsToVar(){
                    this.nextLogsId = 0
                    const { createClient } = microcms;
                    const client = createClient({
                        serviceDomain: this.SERVICE_DOMAIN,
                        apiKey: this.API_KEY,
                    })
                    return client.getAllContents({
                    endpoint: 'logs',
                    }).then((res) =>{ 

                        let contents = res;
                        this.maintenanceLogs = [];                    
                        this.customLogs = [];

                        contents.forEach(content => {

                            dateStr = this.setDateStr(content.date)

                            if(parseFloat(content.id)>this.nextLogsId) this.nextLogsId = parseFloat(content.id)
                            
                            if(content.user_id === this.userId){

                                switch(content.category_flg){
                                    case 1:
                                        this.maintenanceLogs.push({
                                            category_flg : 1,
                                            id: parseFloat(content.id),
                                            item: content.item,
                                            brand: content.brand,
                                            item_code: content.item_code,
                                            price: content.price,
                                            note: content.note,                                         
                                            date: dateStr,
                                        });
                                        break;
                                    case 2:
                                        this.customLogs.push({
                                            category_flg : 2,
                                            id: parseFloat(content.id),
                                            item: content.item,
                                            brand: content.brand,
                                            item_code: content.item_code,
                                            price: content.price,
                                            note: content.note,                                         
                                            date: dateStr,
                                        });
                                        break;
                                };
                            }
                        });
                        this.nextLogsId ++;
                    });
                },
                setItemsToVar(){
                    const { createClient } = microcms;
                    const client = createClient({
                        serviceDomain: this.SERVICE_DOMAIN,
                        apiKey: this.API_KEY,
                    })
                    return client.getAllContents({
                    endpoint: 'mainte_items',
                    }).then((res) =>{ 
                        let contents = res;
                        this.maintenanceItems=[];
                        contents.forEach((content)=>{

                            if(parseFloat(content.id) > this.nextMaintenanceItemsId) this.nextMaintenanceItemsId = parseFloat(content.id)

                            if(content.user_id === this.userId){
                                this.maintenanceItems.push({
                                    id: parseFloat(content.id),
                                    name: content.name,
                                    thresholdDays: content.alert_threshold_days, 
                                });
                            }
                        });
                        this.nextMaintenanceItemsId ++;
                    });
                },
                setEditedVarToTable(){
                    this.cvtIdtoFiveDigitsStrId();
                    
                    const { createClient } = microcms;

                    this.inputBrand = this.inputBrand || "";
                    this.inputItemCode = this.inputItemCode || "";
                    this.inputNote = this.inputNote || "";
                    this.inputPrice = this.inputPrice || 0;

                    const client = createClient({
                        serviceDomain: this.SERVICE_DOMAIN,
                        apiKey: this.API_KEY,
                    })
                    if(this.appStatus !== this.SETTINGS){
                        client.update({
                            endpoint: 'logs',
                            contentId: this.FiveDigitsStrId,
                            content: JSON.parse(
                                                '{"item":' + '"' + this.inputName + '"' + 
                                                ',"brand": ' + '"' + this.inputBrand + '"' +
                                                ',"item_code": '+ '"' + this.inputItemCode + '"' +
                                                ',"price": '+ this.inputPrice +
                                                ',"date": ' + '"' + this.inputDate + '"' +
                                                ',"note":' + '"' + this.inputNote + '"' + "}"
                                                )
                        }).then(()=>{
                            this.initInput();
                            this.setLogsToVar();
                        });
                    }else if(this.appStatus === this.SETTINGS && this.modalStatus !== this.VEHICLE_MODE){
                        if(!this.inputThreshold) this.inputThreshold = 0
                        client.update({
                            endpoint: 'mainte_items',
                            contentId: this.FiveDigitsStrId,
                            content: JSON.parse('{"name":' + '"' + this.inputName + '"' + ',"alert_threshold_days":' + this.inputThreshold + '}')
                        }).then(()=>{
                            this.initInput();
                            this.setItemsToVar();
                        });
                    }else{
                        let imageData = this.tmpImageBase64 ? this.tmpImageBase64 : this.vehicle.imageBase64;
                        client.update({
                            endpoint: 'vehicles',
                            contentId: '00001',
                            content: JSON.parse(
                                                '{"brand":' + '"' + this.inputVBrand + '"' + 
                                                ',"name": ' + '"' + this.inputVName + '"' +
                                                ',"model_code": '+ '"' + this.inputVModelCode + '"' +
                                                ',"purchase_date": '+ '"' + this.inputVDate + '"' +
                                                ',"price": ' + this.inputVPrice +
                                                ',"note":' + '"' + this.inputVNote + '"' + 
                                                ',"image_base64":' + '"' + imageData + '"' +"}"
                                                )
                        }).then(()=>{
                            console.log(this.tmpImageBase64)
                            location.reload();
                        });
                    }
                    this.targetBrand = ""
                    this.targetItemCode = ""
                },
                insertNewRecToLogs(){
                    
                    let content = "";
                    this.inputPrice = this.inputPrice || 0;
                    const { createClient } = microcms;
                    
                    const client = createClient({
                        serviceDomain: this.SERVICE_DOMAIN,
                        apiKey: this.API_KEY,
                    })
                    if(this.appStatus !== this.SETTINGS){
                        this.newRecId =  this.nextLogsId;
                    }else{
                        this.newRecId =  this.nextMaintenanceItemsId;
                    }
                    let category_flg = 0;
                    switch(this.appStatus){                            
                        case this.MAINTENANCE:
                            //HTML上で出していないので初期化しないとundefinedになる
                            this.inputBrand = "";
                            this.inputItemCode = "";
                            category_flg = 1;
                            break;
                        case this.CUSTOM:
                            category_flg = 2;
                            break;
                    };

                    this.cvtIdtoFiveDigitsStrId();
                    
                    if(this.appStatus !== this.SETTINGS){
                        inputPrice = this.inputPrice || 0;
                        client.create({
                        endpoint: 'logs',
                        contentId: this.FiveDigitsStrId,
                        content: JSON.parse(
                                        '{"user_id":' + this.userId +
                                        ',"category_flg":' + category_flg +
                                        ',"item":' + '"' + this.inputName + '"' + 
                                        ',"brand": ' + '"' + this.inputBrand + '"' +
                                        ',"item_code": '+ '"' + this.inputItemCode + '"' +
                                        ',"price": '+ this.inputPrice +
                                        ',"date": ' + '"' + this.inputDate + '"' +
                                        ',"note":' + '"' + this.inputNote + '"}' 
                                        )
                        }).then(()=>{
                            this.initInput();
                            this.setLogsToVar();
                        });
                    }else{
                        this.inputThreshold = this.inputThreshold || 0;
                        content = JSON.parse(
                                        '{"user_id":' + this.userId +
                                        ',"name":' + '"' + this.inputName + '"' + 
                                        ',"alert_threshold_days":' + this.inputThreshold + '}'
                                        )

                        client.create({
                        endpoint: 'mainte_items',
                        contentId: this.FiveDigitsStrId,
                        content: content
                        }).then(()=>{
                            this.initInput();
                            this.setItemsToVar();
                        });
                    }
                },
                deleteRecFromLogs(){
                    this.cvtIdtoFiveDigitsStrId();
                    const { createClient } = microcms;
                    
                    const client = createClient({
                        serviceDomain: this.SERVICE_DOMAIN,
                        apiKey: this.API_KEY,
                    })
                    if(this.appStatus === this.MAINTENANCE || this.appStatus === this.CUSTOM){
                        client.delete({
                            endpoint: 'logs',
                            contentId: this.FiveDigitsStrId,
                        }).then(()=>{
                            this.setLogsToVar();
                            this.isModalVisible = false;
                        });
                    }else{
                        client.delete({
                            endpoint: 'mainte_items',
                            contentId: this.FiveDigitsStrId,
                        }).then(()=>{
                            this.setItemsToVar();
                            this.isModalVisible = false;
                        });
                    }
                },
                //id(ユニークキー)について!important//////////////////
                //microCMSでのid規則制約のため///////////////////////
                //"00001"と文字型5桁の数字としていく//////////////////
                cvtIdtoFiveDigitsStrId(){
                    this.FiveDigitsStrId = "";
                    const ID_LENGTH = 5;
                    let idLengthRemain = 0;
                    if (this.modalStatus === this.EDIT_MODE || this.modalStatus === this.DELETE_MODE) {
                        const STR_TARGET_ID = JSON.stringify(this.targetId);
                        idLengthRemain = ID_LENGTH - STR_TARGET_ID.length;
                        for(let i = 0 ; i < idLengthRemain ; i++) {
                            this.FiveDigitsStrId += "0";
                        }
                        this.FiveDigitsStrId += this.targetId;
                    } else if (this.modalStatus === this.ADD_MODE) {
                        const STR_NEW_ID = JSON.stringify(this.newRecId);
                        idLengthRemain = ID_LENGTH - STR_NEW_ID.length;
                        for(let i = 0 ; i < idLengthRemain ; i++) {
                            this.FiveDigitsStrId += "0";
                        }
                        this.FiveDigitsStrId += this.newRecId;
                    }
                },
                ///////////////////////////////////////////////////////////////////////////////////////////////
            },
            mounted() {
                //PCサイズリダイレクト
                if (window.innerWidth > 1024) window.location.href = 'display-microcms-data-table.html'

                this.setLocalStorageToVar() 
                this.appStatus = this.HOME;
                Promise.all([
                    this.setVehiclesToVar(),
                    this.setLogsToVar(),
                    this.setItemsToVar(),
                ]).then(() => {
                    this.showAlertIfPassed();
                    setTimeout(() => {this.isLoading = false;}, 2000);//最低1秒待つ
                });
            },
        }
        Vue.createApp(appdata).mount("#app")
    </script>
    
</body>
</html>